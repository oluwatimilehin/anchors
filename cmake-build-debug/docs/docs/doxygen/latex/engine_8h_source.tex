\hypertarget{engine_8h_source}{}\doxysection{engine.\+h}
\label{engine_8h_source}\index{/mnt/c/Users/user/Google Drive/CodeProjects/anchors/src/engine.h@{/mnt/c/Users/user/Google Drive/CodeProjects/anchors/src/engine.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{// engine.h}}
\DoxyCodeLine{2 \textcolor{preprocessor}{\#ifndef ANCHORS\_ENGINE\_H}}
\DoxyCodeLine{3 \textcolor{preprocessor}{\#define ANCHORS\_ENGINE\_H}}
\DoxyCodeLine{4 }
\DoxyCodeLine{5 \textcolor{preprocessor}{\#include "{}anchor.h"{}}}
\DoxyCodeLine{6 \textcolor{preprocessor}{\#include "{}anchorutil.h"{}}}
\DoxyCodeLine{7 }
\DoxyCodeLine{8 \textcolor{preprocessor}{\#include <memory>}}
\DoxyCodeLine{9 \textcolor{preprocessor}{\#include <queue>}}
\DoxyCodeLine{10 \textcolor{preprocessor}{\#include <unordered\_set>}}
\DoxyCodeLine{11 }
\DoxyCodeLine{12 \textcolor{keyword}{namespace }anchors \{}
\DoxyCodeLine{13 }
\DoxyCodeLine{19 \textcolor{keyword}{class }\mbox{\hyperlink{classanchors_1_1Engine}{Engine}} \{}
\DoxyCodeLine{20    \textcolor{keyword}{public}:}
\DoxyCodeLine{24     \mbox{\hyperlink{classanchors_1_1Engine_a19d012d2d76c88cb1368be8748df9ed3}{Engine}}();}
\DoxyCodeLine{25 }
\DoxyCodeLine{40     \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{41     T \mbox{\hyperlink{classanchors_1_1Engine_a9bbb22829c003b574174d9f8a8c0191a}{get}}(\textcolor{keyword}{const} AnchorPtr<T>\& anchor);}
\DoxyCodeLine{42 }
\DoxyCodeLine{53     \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{54     \textcolor{keywordtype}{void} \mbox{\hyperlink{classanchors_1_1Engine_a66fa173d6eb7615402aa0abbfd869a1b}{set}}(AnchorPtr<T>\& anchor, T val);}
\DoxyCodeLine{55 }
\DoxyCodeLine{63     \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{64     \textcolor{keywordtype}{void} \mbox{\hyperlink{classanchors_1_1Engine_a8b358a80ca9c9e9a44b3e219250ff783}{observe}}(AnchorPtr<T>\& anchor);}
\DoxyCodeLine{65 }
\DoxyCodeLine{72     \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{73     \textcolor{keywordtype}{void} \mbox{\hyperlink{classanchors_1_1Engine_a8b358a80ca9c9e9a44b3e219250ff783}{observe}}(std::vector<AnchorPtr<T>>\& anchors);}
\DoxyCodeLine{74 }
\DoxyCodeLine{80     \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{81     \textcolor{keywordtype}{void} \mbox{\hyperlink{classanchors_1_1Engine_ab027e6babde932c9b11461a12456207f}{unobserve}}(AnchorPtr<T>\& anchor);}
\DoxyCodeLine{82 }
\DoxyCodeLine{83    \textcolor{keyword}{private}:}
\DoxyCodeLine{84     \textcolor{comment}{// PRIVATE MANIPULATORS}}
\DoxyCodeLine{85     \textcolor{keywordtype}{void} stabilize();}
\DoxyCodeLine{86     \textcolor{comment}{// Brings all observed Anchors up-\/to-\/date.}}
\DoxyCodeLine{87 }
\DoxyCodeLine{88     \textcolor{keywordtype}{void} observeNode(std::shared\_ptr<AnchorBase>\& current,}
\DoxyCodeLine{89                      std::unordered\_set<std::shared\_ptr<AnchorBase>>\&);}
\DoxyCodeLine{90     \textcolor{comment}{// Marks all the dependencies of the given Anchor as necessary and adds}}
\DoxyCodeLine{91     \textcolor{comment}{// stale Anchors to the recompute heap;}}
\DoxyCodeLine{92 }
\DoxyCodeLine{93     \textcolor{keywordtype}{void} unobserveNode(std::shared\_ptr<AnchorBase>\& current);}
\DoxyCodeLine{94     \textcolor{comment}{// Removes `current` from the set of observed Anchors.}}
\DoxyCodeLine{95     \textcolor{comment}{// Also decrements the 'necessary' count and removes `current` as a}}
\DoxyCodeLine{96     \textcolor{comment}{// dependant of each of its dependencies.}}
\DoxyCodeLine{97 }
\DoxyCodeLine{98     \textcolor{comment}{// PRIVATE DATA}}
\DoxyCodeLine{99     \textcolor{keywordtype}{int} d\_stabilizationNumber;}
\DoxyCodeLine{100     \textcolor{comment}{// Current stabilization number of the engine. We use this number to}}
\DoxyCodeLine{101     \textcolor{comment}{// represent when an Anchor value was recomputed and/or changed.}}
\DoxyCodeLine{102 }
\DoxyCodeLine{103     std::unordered\_set<std::shared\_ptr<AnchorBase>> d\_observedNodes;}
\DoxyCodeLine{104     \textcolor{comment}{// Set of observed Anchors.}}
\DoxyCodeLine{105 }
\DoxyCodeLine{106     std::priority\_queue<std::shared\_ptr<AnchorBase>> d\_recomputeHeap;}
\DoxyCodeLine{107     \textcolor{comment}{// Priority queue containing Anchors that need to be recomputed, in}}
\DoxyCodeLine{108     \textcolor{comment}{// increasing order of their heights.}}
\DoxyCodeLine{109 }
\DoxyCodeLine{110     std::unordered\_set<std::shared\_ptr<AnchorBase>> d\_recomputeSet;}
\DoxyCodeLine{111     \textcolor{comment}{// Set of Anchors present in the recompute queue.}}
\DoxyCodeLine{112 }
\DoxyCodeLine{113     \textcolor{comment}{//    std::priority\_queue<std::shared\_ptr<AnchorBase>> d\_adjustHeightsHeap;}}
\DoxyCodeLine{114     \textcolor{comment}{//    // Update the adjust-\/heights heap when setUpdater is called. Will use}}
\DoxyCodeLine{115     \textcolor{comment}{//    later.}}
\DoxyCodeLine{116 \};}
\DoxyCodeLine{117 }
\DoxyCodeLine{118 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{119 T \mbox{\hyperlink{classanchors_1_1Engine_a9bbb22829c003b574174d9f8a8c0191a}{Engine::get}}(\textcolor{keyword}{const} AnchorPtr<T>\& anchor) \{}
\DoxyCodeLine{120     \textcolor{keywordflow}{if} (d\_observedNodes.contains(anchor)) \{}
\DoxyCodeLine{121         stabilize();}
\DoxyCodeLine{122     \}}
\DoxyCodeLine{123 }
\DoxyCodeLine{124     \textcolor{keywordflow}{return} anchor-\/>get();}
\DoxyCodeLine{125 \}}
\DoxyCodeLine{126 }
\DoxyCodeLine{127 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{128 \textcolor{keywordtype}{void} \mbox{\hyperlink{classanchors_1_1Engine_a66fa173d6eb7615402aa0abbfd869a1b}{Engine::set}}(AnchorPtr<T>\& anchor, T val) \{}
\DoxyCodeLine{129     T oldVal = anchor-\/>get();}
\DoxyCodeLine{130 }
\DoxyCodeLine{131     \textcolor{keywordflow}{if} (oldVal == val) \textcolor{keywordflow}{return};}
\DoxyCodeLine{132     d\_stabilizationNumber++;}
\DoxyCodeLine{133 }
\DoxyCodeLine{134     anchor-\/>setChangeId(d\_stabilizationNumber);}
\DoxyCodeLine{135     anchor-\/>set(val);}
\DoxyCodeLine{136 }
\DoxyCodeLine{137     \textcolor{keywordflow}{if} (anchor-\/>isNecessary()) \{}
\DoxyCodeLine{138         \textcolor{keywordflow}{for} (\textcolor{keyword}{const} \textcolor{keyword}{auto}\& parent : anchor-\/>getDependants()) \{}
\DoxyCodeLine{139             \textcolor{keywordflow}{if} (parent-\/>isNecessary() \&\& !d\_recomputeSet.contains(parent)) \{}
\DoxyCodeLine{140                 d\_recomputeHeap.push(parent);}
\DoxyCodeLine{141                 d\_recomputeSet.insert(parent);}
\DoxyCodeLine{142             \}}
\DoxyCodeLine{143         \}}
\DoxyCodeLine{144     \}}
\DoxyCodeLine{145 \}}
\DoxyCodeLine{146 }
\DoxyCodeLine{147 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{148 \textcolor{keywordtype}{void} \mbox{\hyperlink{classanchors_1_1Engine_a8b358a80ca9c9e9a44b3e219250ff783}{Engine::observe}}(AnchorPtr<T>\& anchor) \{}
\DoxyCodeLine{149     \textcolor{keywordflow}{if} (d\_observedNodes.contains(anchor)) \{}
\DoxyCodeLine{150         \textcolor{keywordflow}{return};}
\DoxyCodeLine{151     \}}
\DoxyCodeLine{152 }
\DoxyCodeLine{153     d\_observedNodes.insert(anchor);}
\DoxyCodeLine{154 }
\DoxyCodeLine{155     std::unordered\_set<std::shared\_ptr<AnchorBase>> visited;}
\DoxyCodeLine{156     std::shared\_ptr<AnchorBase>                     anchorBase = anchor;}
\DoxyCodeLine{157     observeNode(anchorBase, visited);}
\DoxyCodeLine{158 \}}
\DoxyCodeLine{159 }
\DoxyCodeLine{160 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{161 \textcolor{keywordtype}{void} \mbox{\hyperlink{classanchors_1_1Engine_a8b358a80ca9c9e9a44b3e219250ff783}{Engine::observe}}(std::vector<AnchorPtr<T>>\& anchors) \{}
\DoxyCodeLine{162     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto}\& anchor : anchors) \{}
\DoxyCodeLine{163         \mbox{\hyperlink{classanchors_1_1Engine_a8b358a80ca9c9e9a44b3e219250ff783}{observe}}(anchor);}
\DoxyCodeLine{164     \}}
\DoxyCodeLine{165 \}}
\DoxyCodeLine{166 }
\DoxyCodeLine{167 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{168 \textcolor{keywordtype}{void} \mbox{\hyperlink{classanchors_1_1Engine_ab027e6babde932c9b11461a12456207f}{Engine::unobserve}}(AnchorPtr<T>\& anchor) \{}
\DoxyCodeLine{169     \textcolor{keywordflow}{if} (!d\_observedNodes.contains(anchor)) \{}
\DoxyCodeLine{170         \textcolor{keywordflow}{return};}
\DoxyCodeLine{171     \}}
\DoxyCodeLine{172 }
\DoxyCodeLine{173     d\_observedNodes.erase(anchor);}
\DoxyCodeLine{174 }
\DoxyCodeLine{175     std::shared\_ptr<AnchorBase> anchorBase = anchor;}
\DoxyCodeLine{176     unobserveNode(anchorBase);}
\DoxyCodeLine{177 \}}
\DoxyCodeLine{178 }
\DoxyCodeLine{179 \}  \textcolor{comment}{// namespace anchors}}
\DoxyCodeLine{180 \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
